const messages = document.getElementById("messages");
const input = document.getElementById("question");
const sendBtn = document.getElementById("sendBtn");

let userName = null;
let displayName = null;
let userLocation = null;
let step = 0; // track conversation step

function addMessage(text, cls) {
  const div = document.createElement("div");
  div.className = "message " + cls;
  div.innerHTML = text;
  messages.appendChild(div);
  scrollToBottom();
}

function scrollToBottom() {
  setTimeout(() => {
    messages.scrollTop = messages.scrollHeight;
  }, 50);
}

async function send() {
  const q = input.value.trim();
  if (!q) return;

  addMessage(q, "user");
  input.value = "";

  // Handle onboarding flow before backend call
  if (step === 0) {
    userName = q;
    if (userName.toLowerCase().includes("vidhya")) {
      displayName = "Vijju";
      addMessage("Naana, how is Chennai weather?", "bot");
      step = 99; // special case step
      return;
    } else {
      displayName = userName;
      addMessage(`Nice to meet you, ${displayName}! ðŸŒŸ Where are you joining from?`, "bot");
      step = 1;
      return;
    }
  }

  if (step === 1) {
    userLocation = q;
    const greeting = `Welcome, ${displayName} from ${userLocation}! ðŸŽ‰`;
    addMessage(`${greeting} You can now ask me about your sales & revenue data.`, "bot");

    // Update header greeting
    document.getElementById("user-greeting").innerText = greeting;

    step = 2;
    return;
  }

  if (step === 99) {
    const reply = q.toLowerCase();
    if (reply.includes("good") || reply.includes("bad")) {
      addMessage("Cool ðŸ˜Ž", "bot");
    } else {
      addMessage("Thanks for sharing, Naana!", "bot");
    }

    // Special greeting for Vidhya
    document.getElementById("user-greeting").innerText = "Welcome, Vijju (Naana) from Chennai!";

    step = 2;
    return;
  }

  // Normal chatbot logic (backend call)
  const thinking = document.createElement("div");
  thinking.className = "message bot";
  thinking.innerText = "Thinking...";
  messages.appendChild(thinking);
  scrollToBottom();

  try {
    const res = await fetch("/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: q })
    });

    const data = await res.json();
    thinking.remove();

    if (data.chat_response) {
      addMessage(data.chat_response, "bot");
    }

    if (data.results && data.results.length > 0) {
      const tableWrapper = document.createElement("div");
      tableWrapper.className = "message bot";

      let tableHtml = "<table><thead><tr>";
      Object.keys(data.results[0]).forEach(k => tableHtml += `<th>${k}</th>`);
      tableHtml += "</tr></thead><tbody>";

      data.results.forEach(row => {
        tableHtml += "<tr>";
        Object.values(row).forEach(v => tableHtml += `<td>${v ?? "-"}</td>`);
        tableHtml += "</tr>";
      });
      tableHtml += "</tbody></table>";

      tableWrapper.innerHTML = tableHtml;
      messages.appendChild(tableWrapper);
      scrollToBottom();
    }

  } catch (e) {
    if (thinking) thinking.remove();
    addMessage("Something went wrong. Please try again.", "bot");
  }
}

sendBtn.addEventListener("click", send);
input.addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    send();
  }
});

window.addEventListener("load", function() {
  setTimeout(function() {
    // Hide welcome message
    document.getElementById("welcome-message").style.display = "none";
    // Show chatbot
    const chat = document.getElementById("chat-container");
    chat.style.display = "flex";
    chat.style.animation = "fadeInUp 1s ease-in-out";

    // Start onboarding: ask for name
    addMessage("ðŸ‘‹ Hi there! May I know your name?", "bot");
  }, 5000); // 5 seconds
});
